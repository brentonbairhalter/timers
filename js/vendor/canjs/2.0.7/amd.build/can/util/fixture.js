/*!
 * CanJS - 2.0.7
 * http://canjs.us/
 * Copyright (c) 2014 Bitovi
 * Wed, 26 Mar 2014 16:12:27 GMT
 * Licensed MIT
 * Includes: CanJS default build
 * Download from: http://canjs.us/
 */

define(["can/util/library","can/util/string","can/util/object"],function(e){if(!e.Object)throw new Error("can.fixture depends on can.Object. Please include it before can.fixture.");var t=function(t){return typeof steal!="undefined"?e.isFunction(steal.config)?steal.config().root.mapJoin(t).toString():steal.root.join(t).toString():(e.fixture.rootUrl||"")+t},n=function(n,r){if(!e.fixture.on)return;var i=function(){};n.type=n.type||n.method||"GET";var s=a(n);if(!n.fixture){window.location.protocol==="file:"&&i("ajax request to "+n.url+", no fixture found");return}typeof n.fixture=="string"&&e.fixture[n.fixture]&&(n.fixture=e.fixture[n.fixture]);if(typeof n.fixture=="string"){var o=n.fixture;/^\/\//.test(o)&&(o=t(n.fixture.substr(2))),s&&(o=e.sub(o,s)),delete n.fixture,n.url=o,n.data=null,n.type="GET",n.error||(n.error=function(e,t,n){throw"fixtures.js Error "+t+" "+n})}else n.dataTypes&&n.dataTypes.splice(0,0,"fixture"),s&&r&&e.extend(r.data,s)},r=function(e,t,n,r){return typeof e!="number"&&(r=t,n=e,t="success",e=200),typeof t!="string"&&(r=n,n=t,t="success"),e>=400&&e<=599&&(this.dataType="text"),[e,t,i(this,n),r]},i=function(e,t){var n=e.dataTypes?e.dataTypes[0]:e.dataType||"json";if(!t||!t[n]){var r={};r[n]=t,t=r}return t};if(e.ajaxPrefilter&&e.ajaxTransport)e.ajaxPrefilter(n),e.ajaxTransport("fixture",function(t,n){t.dataTypes.shift();var s,o=!1;return{send:function(u,a){s=setTimeout(function(){var e=function(){o===!1&&a.apply(null,r.apply(t,arguments))},s=t.fixture(n,e,u,t);s!==undefined&&a(200,"success",i(t,s),{})},e.fixture.delay)},abort:function(){o=!0,clearTimeout(s)}}});else{var s=e.ajax;e.ajax=function(t){n(t,t);if(t.fixture){var i,o=new e.Deferred,u=!1;return o.getResponseHeader=function(){},o.then(t.success,t.fail),o.abort=function(){clearTimeout(i),u=!0,o.reject(o)},i=setTimeout(function(){var e=function(){var e=r.apply(t,arguments),n=e[0];(n>=200&&n<300||n===304)&&u===!1?o.resolve(e[2][t.dataType]):o.reject(o,"error",e[1])},n=t.fixture(t,e,t.headers,t);n!==undefined&&o.resolve(n)},e.fixture.delay),o}return s(t)}}var o=[],u=function(e,t){for(var n=0;n<o.length;n++)if(l._similar(e,o[n],t))return n;return-1},a=function(e){var t=u(e);if(t>-1)return e.fixture=o[t].fixture,l._getData(o[t].url,e.url)},f=function(e){var t=e.data.id;return t===undefined&&typeof e.data=="number"&&(t=e.data),t===undefined&&e.url.replace(/\/(\d+)(\/|$|\.)/g,function(e,n){t=n}),t===undefined&&(t=e.url.replace(/\/(\w+)(\/|$|\.)/g,function(e,n){n!=="update"&&(t=n)})),t===undefined&&(t=Math.round(Math.random()*1e3)),t},l=e.fixture=function(t,n){if(n!==undefined){if(typeof t=="string"){var r=t.match(/(GET|POST|PUT|DELETE) (.+)/i);r?t={url:r[2],type:r[1]}:t={url:t}}var i=u(t,!!n);i>-1&&o.splice(i,1);if(n==null)return;t.fixture=n,o.push(t)}else e.each(t,function(e,t){l(t,e)})},c=e.replacer;return e.extend(e.fixture,{_similar:function(t,n,r){return r?e.Object.same(t,n,{fixture:null}):e.Object.subset(t,n,e.fixture._compare)},_compare:{url:function(e,t){return!!l._getData(t,e)},fixture:null,type:"i"},_getData:function(t,n){var r=[],i=t.replace(".","\\.").replace("?","\\?"),s=(new RegExp(i.replace(c,function(e,t){return r.push(t),"([^/]+)"})+"$")).exec(n),o={};return s?(s.shift(),e.each(r,function(e){o[e]=s.shift()}),o):null},store:function(t,n,r,i){var s=[],o=0,u=function(e){for(var t=0;t<s.length;t++)if(e==s[t].id)return s[t]},a={};typeof t=="string"?t=[t+"s",t]:e.isArray(t)||(i=r,r=n,n=t),e.extend(a,{findAll:function(t){t=t||{};var n=s.slice(0);t.data=t.data||{},e.each((t.data.order||[]).slice(0).reverse(),function(e){var t=e.split(" ");n=n.sort(function(e,n){return t[1].toUpperCase()!=="ASC"?e[t[0]]<n[t[0]]?1:e[t[0]]===n[t[0]]?0:-1:e[t[0]]<n[t[0]]?-1:e[t[0]]===n[t[0]]?0:1})}),e.each((t.data.group||[]).slice(0).reverse(),function(e){var t=e.split(" ");n=n.sort(function(e,n){return e[t[0]]>n[t[0]]})});var r=parseInt(t.data.offset,10)||0,o=parseInt(t.data.limit,10)||s.length-r,u=0;for(var a in t.data){u=0;if(t.data[a]!==undefined&&(a.indexOf("Id")!==-1||a.indexOf("_id")!==-1))while(u<n.length)t.data[a]!=n[u][a]?n.splice(u,1):u++}if(i){u=0;while(u<n.length)i(n[u],t)?u++:n.splice(u,1)}return{count:n.length,limit:t.data.limit,offset:t.data.offset,data:n.slice(r,r+o)}},findOne:function(e,t){var n=u(f(e));t(n?n:undefined)},update:function(t,n){var r=f(t);e.extend(u(r),t.data),n({id:f(t)},{location:t.url||"/"+f(t)})},destroy:function(t){var n=f(t);for(var r=0;r<s.length;r++)if(s[r].id==n){s.splice(r,1);break}return e.extend(u(n)||{},t.data),{}},create:function(t,n){var i=r(s.length,s);e.extend(i,t.data),i.id||(i.id=o++),s.push(i),n({id:i.id},{location:t.url+"/"+i.id})}});var l=function(){s=[];for(var i=0;i<n;i++){var u=r(i,s);u.id||(u.id=i),o=Math.max(u.id+1,o+1)||s.length,s.push(u)}e.isArray(t)&&(e.fixture["~"+t[0]]=s,e.fixture["-"+t[0]]=a.findAll,e.fixture["-"+t[1]]=a.findOne,e.fixture["-"+t[1]+"Update"]=a.update,e.fixture["-"+t[1]+"Destroy"]=a.destroy,e.fixture["-"+t[1]+"Create"]=a.create)};return l(),e.extend({getId:f,find:function(e){return u(f(e))},reset:l},a)},rand:function h(e,t,n){if(typeof e=="number")return typeof t=="number"?e+Math.floor(Math.random()*(t-e)):Math.floor(Math.random()*e);var r=h;if(t===undefined)return r(e,r(e.length+1));var i=[];e=e.slice(0),n||(n=t),n=t+Math.round(r(n-t));for(var s=0;s<n;s++)i.push(e.splice(r(e.length),1)[0]);return i},xhr:function(t){return e.extend({},{abort:e.noop,getAllResponseHeaders:function(){return""},getResponseHeader:function(){return""},open:e.noop,overrideMimeType:e.noop,readyState:4,responseText:"",responseXML:null,send:e.noop,setRequestHeader:e.noop,status:200,statusText:"OK"},t)},on:!0}),e.fixture.delay=200,e.fixture.rootUrl=t(""),e.fixture["-handleFunction"]=function(t){return typeof t.fixture=="string"&&e.fixture[t.fixture]&&(t.fixture=e.fixture[t.fixture]),typeof t.fixture=="function"?(setTimeout(function(){t.success&&t.success.apply(null,t.fixture(t,"success")),t.complete&&t.complete.apply(null,t.fixture(t,"complete"))},e.fixture.delay),!0):!1},e.fixture.overwrites=o,e.fixture.make=e.fixture.store,e.fixture});